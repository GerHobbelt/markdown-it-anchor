{"version":3,"file":"markdownItAnchor.modern.js","sources":["../index.js"],"sourcesContent":["\nconst slugify = (s) => encodeURIComponent(String(s).trim().toLowerCase().replace(/\\s+/g, '-'));\n\nconst position = {\n  'false': 'push',\n  'true': 'unshift'\n};\n\nconst permalinkHref = slug => `#${slug}`;\nconst permalinkAttrs = slug => ({});\n\nfunction renderPermalink(slug, opts, state, idx) {\n  const space = () => Object.assign(new state.Token('text', '', 0), { content: ' ' });\n\n  const linkTokens = [\n    Object.assign(new state.Token('link_open', 'a', 1), {\n      attrs: [\n        ...(opts.permalinkClass ? [ [ 'class', opts.permalinkClass ] ] : []),\n        [ 'href', opts.permalinkHref(slug, state) ],\n        ...Object.entries(opts.permalinkAttrs(slug, state))\n      ]\n    }),\n    Object.assign(new state.Token('html_block', '', 0), { content: opts.permalinkSymbol }),\n    new state.Token('link_close', 'a', -1)\n  ];\n\n  // `push` or `unshift` according to position option.\n  // Space is at the opposite side.\n  if (opts.permalinkSpace) {\n    linkTokens[position[!opts.permalinkBefore]](space());\n  }\n\n  for (let j = idx + 1, iK = state.tokens.length; j < iK; j++) {\n    const token = state.tokens[j];\n    if (token.type === 'heading_close') { break; }\n    if (!token.children) { continue; }\n    token.children[position[opts.permalinkBefore]](...linkTokens);\n    break;\n  }\n}\n\nfunction uniqueSlug(slug, slugs, failOnNonUnique, startIndex) {\n  // If first slug, return as is.\n  let key = slug;\n  let n = startIndex;\n  if (slugs.has(key) && failOnNonUnique) {\n    throw new Error(`The ID attribute '${slug}' defined by user or other markdown-it plugin is not unique. Please fix it in your markdown to continue.`);\n  }\n\n  while (slugs.has(key)) {\n    // Duplicate slug, add a `-1`, `-2`, etc. to keep ID unique.\n    key = `${slug}-${n++}`;\n  }\n\n  // Mark this slug as used in the environment.\n  slugs.set(key, true);\n  return key;\n}\n\nconst isLevelSelectedNumber = selection => level => level <= selection;\nconst isLevelSelectedArray = selection => level => selection.includes(level);\n\nconst anchor = (md, opts) => {\n  opts = Object.assign({}, anchor.defaults, opts);\n\n  md.core.ruler.push('anchor', state => {\n    const slugs = new Map();\n    const tokens = state.tokens;\n\n    const isLevelSelected = Array.isArray(opts.level)\n      ? isLevelSelectedArray(opts.level)\n      : isLevelSelectedNumber(opts.level);\n\n    tokens.forEach((token, i) => {\n      if (token.type !== 'heading_open') {\n        return;\n      }\n\n      // Before we do anything, we must collect all previously defined ID attributes to ensure we won't generate any duplicates:\n      let slug = token.attrGet('id');\n\n      if (slug != null) {\n        // mark existing slug/ID as unique, at least.\n        // IFF it collides, FAIL!\n        slug = uniqueSlug(slug, slugs, true);\n      }\n    });\n\n    tokens.forEach((token, i) => {\n      if (token.type !== 'heading_open') {\n        return;\n      }\n\n      if (!isLevelSelected(Number(token.tag.substr(1)))) {\n        return;\n      }\n\n      // Aggregate the next token children text.\n      let keyparts = [];\n      for (let j = i + 1, iK = tokens.length; j < iK; j++) {\n        const token = tokens[j];\n        if (token.type === 'heading_close') { break; }\n        if (!token.children) { continue; }\n        const keypart = token.children\n        .filter(token => token.type === 'text' || token.type === 'code_inline')\n        .reduce((acc, t) => acc + t.content, '')\n        .trim();\n        if (keypart.length > 0) {\n          keyparts.push(keypart);\n        }\n      }\n      const title = keyparts.join(' ');\n      let slug = token.attrGet('id');\n\n      if (slug == null) {\n        slug = uniqueSlug(opts.slugify(title), slugs, false, opts.uniqueSlugStartIndex);\n        token.attrSet('id', slug);\n      }\n\n      if (opts.permalink) {\n        opts.renderPermalink(slug, opts, state, i);\n      }\n\n      if (opts.callback) {\n        opts.callback(token, { slug, title });\n      }\n    });\n  });\n};\n\nanchor.defaults = {\n  level: 6,                    // **max** level or array of levels\n  slugify,\n  uniqueSlugStartIndex: 1,\n  permalink: false,\n  renderPermalink,\n  permalinkClass: 'header-anchor',\n  permalinkSpace: true,\n  permalinkSymbol: 'Â¶',\n  permalinkBefore: false,\n  permalinkHref,\n  permalinkAttrs\n};\n\nexport default anchor;\n"],"names":["slugify","s","encodeURIComponent","String","trim","toLowerCase","replace","position","permalinkHref","slug","permalinkAttrs","renderPermalink","opts","state","idx","space","Object","assign","Token","content","linkTokens","attrs","permalinkClass","entries","permalinkSymbol","permalinkSpace","permalinkBefore","j","iK","tokens","length","token","type","children","uniqueSlug","slugs","failOnNonUnique","startIndex","key","n","has","Error","set","isLevelSelectedNumber","selection","level","isLevelSelectedArray","includes","anchor","md","defaults","core","ruler","push","Map","isLevelSelected","Array","isArray","forEach","i","attrGet","Number","tag","substr","keyparts","keypart","filter","reduce","acc","t","title","join","uniqueSlugStartIndex","attrSet","permalink","callback"],"mappings":"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"}