{"version":3,"file":"markdownItAnchor.js","sources":["../index.js"],"sourcesContent":["\nconst slugify = (s) => encodeURIComponent(String(s).trim().toLowerCase().replace(/\\s+/g, '-'));\n\nconst position = {\n  'false': 'push',\n  'true': 'unshift'\n};\n\nconst permalinkHref = slug => `#${slug}`;\nconst permalinkAttrs = slug => ({});\n\nfunction renderPermalink(slug, opts, state, idx) {\n  const space = () => Object.assign(new state.Token('text', '', 0), { content: ' ' });\n\n  const linkTokens = [\n    Object.assign(new state.Token('link_open', 'a', 1), {\n      attrs: [\n        [ 'class', opts.permalinkClass ],\n        [ 'href', opts.permalinkHref(slug, state) ],\n        ...Object.entries(opts.permalinkAttrs(slug, state))\n      ]\n    }),\n    Object.assign(new state.Token('html_block', '', 0), { content: opts.permalinkSymbol }),\n    new state.Token('link_close', 'a', -1)\n  ];\n\n  // `push` or `unshift` according to position option.\n  // Space is at the opposite side.\n  if (opts.permalinkSpace) {\n    linkTokens[position[!opts.permalinkBefore]](space());\n  }\n  state.tokens[idx + 1].children[position[opts.permalinkBefore]](...linkTokens);\n}\n\nfunction uniqueSlug(slug, slugs, failOnNonUnique) {\n  // If first slug, return as is.\n  let key = slug;\n  let n = 2;\n  if (slugs.has(key) && failOnNonUnique) {\n    throw new Error(`The ID attribute '${slug}' defined by user or other markdown-it plugin is not unique. Please fix it in your markdown to continue.`);\n  }\n\n  while (slugs.has(key)) {\n    // Duplicate slug, add a `-2`, `-3`, etc. to keep ID unique.\n    key = `${slug}-${n++}`;\n  }\n\n  // Mark this slug as used in the environment.\n  slugs.set(key, true);\n  return key;\n}\n\nconst isLevelSelectedNumber = selection => level => level <= selection;\nconst isLevelSelectedArray = selection => level => selection.includes(level);\n\nconst anchor = (md, opts) => {\n  opts = Object.assign({}, anchor.defaults, opts);\n\n  md.core.ruler.push('anchor', state => {\n    const slugs = new Map();\n    const tokens = state.tokens;\n\n    const isLevelSelected = Array.isArray(opts.level)\n      ? isLevelSelectedArray(opts.level)\n      : isLevelSelectedNumber(opts.level);\n\n    let htoks = tokens\n      .filter(token => token.type === 'heading_open');\n\n    htoks\n      .forEach(token => {\n        // Before we do anything, we must collect all previously defined ID attributes to ensure we won't generate any duplicates:\n        let slug = token.attrGet('id');\n\n        if (slug != null) {\n          // mark existing slug/ID as unique, at least.\n          // IFF it collides, FAIL!\n          slug = uniqueSlug(slug, slugs, true);\n        }\n      });\n\n    htoks\n      .filter(token => isLevelSelected(Number(token.tag.substr(1))))\n      .forEach(token => {\n        // Aggregate the next token children text.\n        const idx = tokens.indexOf(token);\n        const title = tokens[idx + 1]\n          .children\n          .filter(child_token => child_token.type === 'text' || child_token.type === 'code_inline')\n          .reduce((acc, t) => acc + t.content, '');\n\n        let slug = token.attrGet('id');\n\n        if (slug == null) {\n          slug = uniqueSlug(opts.slugify(title), slugs, false);\n          token.attrSet('id', slug);\n        }\n\n        if (opts.permalink) {\n          opts.renderPermalink(slug, opts, state, idx);\n        }\n\n        if (opts.callback) {\n          opts.callback(token, { slug, title });\n        }\n      });\n  });\n};\n\nanchor.defaults = {\n  level: 6,                    // **max** level or array of levels\n  slugify,\n  permalink: false,\n  renderPermalink,\n  permalinkClass: 'header-anchor',\n  permalinkSpace: true,\n  permalinkSymbol: 'Â¶',\n  permalinkBefore: false,\n  permalinkHref,\n  permalinkAttrs\n};\n\nmodule.exports = anchor;\n"],"names":["slugify","s","encodeURIComponent","String","trim","toLowerCase","replace","position","permalinkHref","slug","permalinkAttrs","renderPermalink","opts","state","idx","space","Object","assign","Token","content","linkTokens","attrs","permalinkClass","entries","permalinkSymbol","permalinkSpace","permalinkBefore","tokens","children","uniqueSlug","slugs","failOnNonUnique","key","n","has","Error","set","isLevelSelectedNumber","selection","level","isLevelSelectedArray","includes","anchor","md","defaults","core","ruler","push","Map","isLevelSelected","Array","isArray","htoks","filter","token","type","forEach","attrGet","Number","tag","substr","indexOf","title","child_token","reduce","acc","t","attrSet","permalink","callback","module","exports"],"mappings":"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"}